<?xml version="1.0"?>
<!DOCTYPE profile>
<profile xmlns="http://www.suse.com/1.0/yast2ns" xmlns:config="http://www.suse.com/1.0/configns">

  <partitioning config:type="list">
    <drive>
      <use>all</use>
    </drive>
  </partitioning>

  <general>
    <mode>
      <!-- automation setting -->
      <confirm config:type="boolean">false</confirm>
    </mode>
  </general>

  <!-- users settings -->
  <users config:type="list">
    <user>
      <encrypted config:type="boolean">true</encrypted>
      <fullname>root</fullname>
      <gid>0</gid>
      <uid>0</uid>
      <user_password><%=rootEncryptedPassword%></user_password>
      <username>root</username>
    </user>
<% users.forEach(function(user) { %>
    <user>
      <encrypted config:type="boolean">true</encrypted>
      <fullname><%=user.name%></fullname>
      <user_password><%=user.encryptedPassword%></user_password>
      <username><%=user.name%></username>
    </user>
<% }) %>
  </users>

  <networking>
    <keep_install_network config:type="boolean">true</keep_install_network>
    <dns>
      <dhcp_hostname config:type="boolean">true</dhcp_hostname>
      <dhcp_resolv config:type="boolean">true</dhcp_resolv>
      <domain><%=domain%></domain>
      <hostname><%=hostname%></hostname>
      <write_hostname config:type="boolean">true</write_hostname>
    </dns>
  </networking>

  <software>
    <packages config:type="list">
      <package>openssh</package>
    </packages>
  </software>
  <services-manager>
    <default_target>multi-user</default_target>
    <services>
      <enable config:type="list">
        <service>sshd</service>
      </enable>
    </services>
  </services-manager>

  <scripts>
    <chroot-scripts config:type="list"> 
      <script>
        <chrooted config:type="boolean">true</chrooted>
        <interpreter>shell</interpreter>
        <!-- scripts for workflow completion -->
        <source> <![CDATA[
          #!/bin/sh
          curl http://<%=server%>:<%=port%>/api/common/templates/renasar-ansible.pub
          ]]>
        </source>
      </script>
    </chroot-scripts>

    <post-scripts config:type="list"> 
      <script>
        <interpreter>shell</interpreter>
        <chrooted config:type="boolean">true</chrooted>
        <source> <![CDATA[
          #!/bin/sh

          # Make .ssh directory for root and users

          # Set root ssh key
          <% if (typeof rootSshKey !== 'undefined') { %>
                mkdir /root/.ssh
                echo <%=rootSshKey%> > /root/.ssh/authorized_keys
                chown -R root:root /root/.ssh
          <% } %>

          # Set users ssh key
          <% users.forEach(function(user) { %>
            <% if (typeof user.sshKey !== 'undefined') { %>
                mkdir /home/<%=user.name%>/.ssh 
                echo <%=user.sshKey%> > /home/<%=user.name%>/.ssh/authorized_keys
                chown -R <%=user.name%>:users /home/<%=user.name%>/.ssh
            <% } %>
          <% }) %>
          ]]>
        </source>
      </script>
    </post-scripts>
  </scripts>

</profile>
